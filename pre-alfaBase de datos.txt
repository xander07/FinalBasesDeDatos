CREATE TABLE observador (id INT PRIMARY KEY CHECK (id>0), 
			nombre VARCHAR(30) NOT NULL, 
			fecha_nacimiento DATE NOT NULL,
			email VARCHAR(20) NOT NULL UNIQUE,
			contrasena VARCHAR(20) NOT NULL, 
			tipo VARCHAR(11) NOT NULL)ENGINE = InnoDB;

ALTER TABLE observador ADD CONSTRAINT tipo_valido CHECK(tipo=observador OR tipo=vendedor OR tipo=comprador);

CREATE TABLE vendedor (cVendedor INT PRIMARY KEY,
			codVendedor VARCHAR(11) NOT NULL UNIQUE,
			pais VARCHAR(15) NOT NULL,
			alcance VARCHAR(15) NOT NULL)ENGINE = InnoDB;

ALTER TABLE vendedor ADD FOREIGN KEY(cVendedor) REFERENCES observador(id);

CREATE TABLE comprador (cComprador INT(10) PRIMARY KEY,
			codComprador VARCHAR(11) NOT NULL UNIQUE);

ALTER TABLE comprador ADD FOREIGN KEY(cComprador) REFERENCES observador(id);

CREATE TABLE moderador (codigoModerador VARCHAR(15) PRIMARY KEY,
			nombre VARCHAR(30) NOT NULL,
			moderadorPassword VARCHAR(30) NOT NULL)ENGINE = InnoDB;

CREATE TABLE articulo (codigoArticulo INT AUTO_INCREMENT PRIMARY KEY,
			nombre VARCHAR(30) NOT NULL,
			descripcion TEXT NOT NULL,
			categoria VARCHAR (30) NOT NULL,
			estado VARCHAR(15) NOT NULL,
			idPropietario VARCHAR(11) NOT NULL,
			tipoPropietario VARCHAR(15) NOT NULL,
			codigoVendedor INT NOT NULL,
			codigoSubasta VARCHAR(15))ENGINE = InnoDB;

ALTER TABLE articulo ADD CONSTRAINT tipo_prop CHECK(tipo=comprador OR tipo=vendedor);
ALTER TABLE articulo ADD FOREIGN KEY(codigoVendedor) REFERENCES vendedor(cVendedor) ON DELETE CASCADE;
ALTER TABLE articulo ADD FOREIGN KEY(codigoSubasta) REFERENCES subasta(codigoSubasta);

CREATE TABLE puja (idPuja VARCHAR(15) PRIMARY KEY,
		   valor INT NOT NULL,
		   codigoPujador VARCHAR(15) NOT NULL,
		   tipoPujador VARCHAR(15) NOT NULL,
		   codigoSubasta VARCHAR(15) NOT NULL)ENGINE = InnoDB;

ALTER TABLE puja ADD CONSTRAINT tipo_pujador CHECK(tipoPujador=comprador OR tipoPujador=vendedor);
ALTER TABLE puja ADD FOREIGN KEY(codigoSubasta) REFERENCES subasta(CodigoSubasta);

CREATE TABLE subasta (codigoSubasta VARCHAR(15) PRIMARY KEY, 
		      valorInicial INT(10) NOT NULL,
		      pujaMasAlta VARCHAR(15),
		      estado VARCHAR(10) NOT NULL,
		      fechaDeInicio DATE NOT NULL,
		      codigoModerador VARCHAR(15) NOT NULL,
		      productoASubastar INT NOT NULL,
		      vendedor INT NOT NULL)ENGINE = InnoDB;

ALTER TABLE subasta ADD FOREIGN KEY(productoASubastar) REFERENCES articulo(codigoArticulo);
ALTER TABLE subasta ADD FOREIGN KEY(pujaMasAlta) REFERENCES puja(idPuja);
ALTER TABLE subasta ADD FOREIGN KEY(codigoModerador) REFERENCES moderador(codigoModerador);
ALTER TABLE subasta ADD FOREIGN KEY(vendedor) REFERENCES vendedor(cVendedor);

CREATE TABLE visita (idVisita VARCHAR(15) PRIMARY KEY,
		     idObservador INT NOT NULL,
		     codigoSubasta VARCHAR(15) NOT NULL, 
		     fecha DATE NOT NULL)ENGINE = InnoDB;

ALTER TABLE visita ADD FOREIGN KEY(idObservador) REFERENCES observador(id);
ALTER TABLE visita ADD FOREIGN KEY(codigoSubasta) REFERENCES subasta(codigoSubasta);

CREATE TABLE reputacion (codigoVendedor INT PRIMARY KEY,
			 puntuacion FLOAT(2) NOT NULL,
			 calificadaPor VARCHAR(15) NOT NULL,
			 tipoCalificador VARCHAR(15) NOT NULL)ENGINE = InnoDB;

ALTER TABLE reputacion ADD FOREIGN KEY(codigoVendedor) REFERENCES vendedor(cVendedor);
ALTER TABLE reputacion ADD CONSTRAINT calificadorValido CHECK(tipoCalificador='vendedor' OR tipoCalificador='comprador');
ALTER TABLE reputacion ADD CONSTRAINT noSiMismo CHECK(calificadaPor != codigoVendedor);

CREATE TABLE comentarioArticulo (CodComentario VARCHAR(15) PRIMARY KEY,
				  descripcion TEXT NOT NULL,
				  fecha DATE NOT NULL,
				  hechoPor INT NOT NULL,
				  articuloComentado INT NOT NULL)ENGINE = InnoDB;

ALTER TABLE comentarioArticulo ADD FOREIGN KEY(hechoPor) REFERENCES observador(id);
ALTER TABLE comentarioArticulo ADD FOREIGN KEY(articuloComentado) REFERENCES articulo(codigoArticulo);

CREATE TABLE comentarioReputacion (Codcomentario VARCHAR(11) PRIMARY KEY,
				    descripcion TEXT NOT NULL,
				    fecha DATE NOT NULL,
				    calificacion FLOAT(2) NOT NULL,
				    codReputacion INT NOT NULL,
				    autor INT NOT NULL,
				    tipoAutor VARCHAR(15) NOT NULL)ENGINE = InnoDB;

ALTER TABLE comentarioReputacion ADD FOREIGN KEY(codReputacion) REFERENCES reputacion(codigoVendedor);
ALTER TABLE comentarioReputacion ADD FOREIGN KEY(autor) REFERENCES observador(id);
ALTER TABLE comentarioReputacion ADD CONSTRAINT tipoAutor CHECK(tipoAutor = 'comprador' OR tipoAutor='vendedor');